// This is your Prisma schema file
// Learn more at: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// User model for authentication and progress tracking
model User {
  id           String   @id @default(uuid())
  email        String?  @unique
  username     String   @unique
  passwordHash String?
  isGuest      Boolean  @default(false)
  
  // Gamification
  xp           Int      @default(0)
  level        Int      @default(1)
  streakDays   Int      @default(0)
  lastActiveAt DateTime @default(now())
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  quizSessions QuizSession[]
  badges       UserBadge[]
  signProgress SignProgress[]
}

// Traffic Sign model
model Sign {
  id          String   @id @default(uuid())
  name        String
  category    String   // WARNING, REGULATORY, GUIDE, CONSTRUCTION, RECREATION
  description String
  imageUrl    String
  rules       String
  region      String   @default("US")
  
  createdAt   DateTime @default(now())
  
  // Relations
  questions   QuizQuestion[]
  progress    SignProgress[]
}

// User's progress on each sign
model SignProgress {
  id            String   @id @default(uuid())
  userId        String
  signId        String
  timesCorrect  Int      @default(0)
  timesIncorrect Int     @default(0)
  mastered      Boolean  @default(false)
  lastPracticed DateTime @default(now())
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  sign          Sign     @relation(fields: [signId], references: [id], onDelete: Cascade)
  
  @@unique([userId, signId])
}

// Quiz Question model
model QuizQuestion {
  id            String   @id @default(uuid())
  signId        String
  questionText  String
  options       String   // JSON array of options
  correctAnswer Int
  difficulty    Int      @default(1) // 1-3
  explanation   String
  
  sign          Sign     @relation(fields: [signId], references: [id], onDelete: Cascade)
  answers       QuizAnswer[]
}

// Quiz Session model
model QuizSession {
  id           String   @id @default(uuid())
  userId       String
  type         String   @default("practice") // daily, practice, category, speed
  totalQuestions Int
  correctAnswers Int    @default(0)
  xpEarned     Int      @default(0)
  completedAt  DateTime?
  
  createdAt    DateTime @default(now())
  
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  answers      QuizAnswer[]
}

// Individual quiz answer
model QuizAnswer {
  id           String   @id @default(uuid())
  sessionId    String
  questionId   String
  selectedAnswer Int
  isCorrect    Boolean
  timeSpentMs  Int      @default(0)
  
  session      QuizSession  @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  question     QuizQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
}

// Badge definitions
model Badge {
  id          String   @id @default(uuid())
  name        String   @unique
  description String
  iconUrl     String
  requirement String   // JSON describing how to earn
  
  users       UserBadge[]
}

// User's earned badges
model UserBadge {
  id       String   @id @default(uuid())
  userId   String
  badgeId  String
  earnedAt DateTime @default(now())
  
  user     User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  badge    Badge    @relation(fields: [badgeId], references: [id], onDelete: Cascade)
  
  @@unique([userId, badgeId])
}
